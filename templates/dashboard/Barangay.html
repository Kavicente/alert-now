<script>
        let menuData = {
            'Road Accident': {
                'Road Accident Cause': ['Head-on Collision', 'Rear-end Collision', 'Side-impact Collision', 'Single Vehicle Accident', 'Pedestrian Accident'],
                'Road Accident Type': ['Overspeeding', 'Distracted Driving', 'Drunk Driving', 'Reckless Driving', 'Fatigue', 'Inexperience', 'Mechanical Failure', 'Poor Maintenance', 'Overloading'],
                'Weather Conditions': ['Sunny', 'Rainy', 'Foggy', 'Cloudy', 'Stormy'],
                'Road Conditions': ['Dry', 'Wet', 'Icy', 'Potholes', 'Gravel'],
                'Vehicle Types': ['Car', 'Motorcycle', 'Truck', 'Bus', 'Bicycle', 'Car and Motorcycle', 'Car and Bus', 'Car and Truck', 'Car and Bicycle', 'Motorcycle and Car', 'Motorcycle and Bus', 'Motorcycle and Truck', 'Motorcycle and Bicycle', 'Truck and Car', 'Truck and Motorcycle', 'Truck and Bus', 'Truck and Bicycle', 'Bus and Car', 'Bus and Motorcycle', 'Bus and Truck', 'Bus and Bicycle', 'Bicycle and Car', 'Bicycle and Motorcycle', 'Bicycle and Bus', 'Bicycle and Truck'],
                'Driver Ages': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Driver Gender': ['Male', 'Female']
            },
            'Fire Incident': {
                'Fire Cause': [
                    'Electrical ignition caused by loose connection', 'Electrical ignition caused by overloading', 'Electrical ignition due to pinched wire',
                    'Electrical ignition caused by arcing', 'Overheated industrial machinery', 'Sparks from machinery', 'Overheated home appliances', 'Electrical post fire to structural fire',
                    'Transformer pole fire to structural fire', 'Open flame from cooking (LPG / gas stove, firewood)', 'Open flame from unattended lighted candle',
                    'Open flame from kerosene lamp (gasera) / lighting torch (sulo)', 'Open flame from rubbish fire / bonfire to structural fire',
                    'Open flame from farmland / agricultural land clearing operation', 'Open flame from kaingin (slash and burn)',
                    'Ignition caused by firecracker explosion', 'Ignition caused by fireworks / pyrotechnics explosion', 'Ignition caused by bomb explosion',
                    'Spontaneous combustion of chemicals', 'Spontaneous combustion of solid materials',
                    'Intentional fire by use of incendiary device or mechanism', 'Intentional fire by use of flammable liquid',
                    'Intentional fire by use of open flame (matchstick or lighter or light torch)', 'Ignition of material caused by welding slags',
                    'Ignition of materials caused by acetylene / other hot works', 'LPG explosion caused by defective tank',
                    'LPG explosion caused by defective hose line', 'LPG explosion caused by defective regulator',
                    'LPG explosion caused by defective stove', 'LPG explosion caused by static electricity or spark',
                    'Fire caused by lightning', 'Ignition of materials from ember / flying ember or alipato',
                    'Smoking (lighted cigarette, cigar or pipe)', 'Children playing matchstick or lighter',
                    'Battery short circuit or battery explosion', 'Dust explosion', 'Magnified / amplified sun rays',
                    'Overheated engine (motor vehicles)', 'Sky lantern', 'Fire incident under investigation (on process)',
                    'Undetermined fire cause (on pending investigation)'
                ],
                'Occupancy Type': [
                    'Assembly', 'Educational', 'Day-Care', 'Health Care',
                    'Detention & Correctional / Institutional', 'Residential',
                    'Mercantile', 'Business', 'Industrial', 'Storage',
                    'Mixed Occupancies', 'Miscellaneous Occupancies'
                ],
                'Class': {
                    'CLASS A': 'Ordinary Combustibles\n(Wood, paper, cloth, plastic, rubber, trash, and other common combustible materials. Extinguishing Method: Water, foam, dry chemical.)',
                    'CLASS B': 'Flammable Liquids & Gases\n(Gasoline, diesel, alcohol, paints, solvents, kerosene, LPG, acetylene, etc. Extinguishing Method: Foam, dry chemical (ABC/BC), CO2. Do NOT use water - it spreads the flammable liquid.)',
                    'CLASS C': 'Energized Electrical Equipment\n(Electrical panels, wirings, appliances, transformers, computers, breakers. Extinguishing Method: Dry chemical, CO2.)',
                    'CLASS D': 'Combustible Metals\n(Magnesium, titanium, sodium, potassium, zirconium, lithium. Extinguishing Method: Special Class D dry powder extinguishers. Do NOT use water - it reacts violently.)',
                    'CLASS K (or Class F)': 'Cooking Oils & Fats\n(Hot oils and fats from deep fryers, lard, shortening, grease.)'
                }
            },
            'Crime Incident': {
                'Crime Types': ['Theft', 'Assault', 'Burglary', 'Robbery', 'Vandalism', 'Harassment', 'Domestic Violence', 'Drug-Related', 'Fraud'],
                'Crime Causes': ['Poverty', 'Unemployment', 'Alcohol', 'Drugs', 'Personal Dispute', 'Gang Activity', 'Opportunistic', 'Domestic Issue', 'Mental Health'],
                'Levels': ['Low', 'Medium', 'High'],
                'Suspect Gender': ['Male', 'Female'],
                'Victim Gender': ['Male', 'Female'],
                'Suspect Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+'],
                'Victim Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+']
            },
            'Health Emergency': {
                'Health Emergency Types': ['Heart Attack', 'Stroke', 'Fall', 'Breathing Difficulty', 'Giving Birth', 'Seizure', 'Burn', 'Poisoning', 'Allergic Reaction'],
                'Health Causes': ['Pregnant', 'Chronic Illness', 'Accident', 'Allergy', 'Infection', 'Overdose', 'Heatstroke'],
                'Patient Gender': ['Male', 'Female'],
                'Patient Age': ['0-17', '18-25', '26-35', '36-45', '46-60', '61+']
            }
        };

        // Track alerts
        const liveAlerts = new Map();   // alert_id → { element, timestamp }
        const recentAlerts = new Map();
        const alertElements = new Map(); // for response updates

        window.activeMarkers = window.activeMarkers || {};


        

        function scrollToCharts() {
            const chartsSection = document.querySelector('.prediction-charts-grid');
            if (chartsSection) {
                chartsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        

        // Move alert from Live → Recent after 60 seconds
        function moveToRecent(alertId) {
            if (!liveAlerts.has(alertId)) return;
            const { element } = liveAlerts.get(alertId);
            liveAlerts.delete(alertId);
            recentAlerts.set(alertId, { element, timestamp: Date.now() });
            
            element.querySelector('div:first-child').textContent = 'EXPIRED ALERT';
            document.getElementById('recent-alert-container')
                    .insertBefore(element, document.getElementById('recent-alert-container').firstChild);
        }

        // Tab switching
        document.querySelectorAll('.alert-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.alert-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + '-alerts-tab').classList.add('active');
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('shifted');
        }

        

        document.addEventListener('DOMContentLoaded', () => {
            
            const lat = {{ lat_coord|default(14.0549) }};
            const lon = {{ lon_coord|default(121.3013) }};
            const mapboxToken = 'pk.eyJ1Ijoia3VtaXRva2lydSIsImEiOiJjbWNvZXpkdDQwNmdvMnNyMnNtNGw5NGI1In0.3Y9z5y4saOL76Eb5c-o0UQ';
            const tileLayerUrl = `https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v11/tiles/{z}/{x}/{y}?access_token=${mapboxToken}`;

            const barangayMap = L.map('map').setView([lat, lon], 16);

            var satellite = L.tileLayer(tileLayerUrl, {
                attribution: 'Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                tileSize: 512,
                zoomOffset: -1
            });

            var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            });

            satellite.addTo(barangayMap);

            var baseLayers = {
                "Satellite with Labels": satellite,
                "OpenStreetMap": osm
            };
            L.control.layers(baseLayers).addTo(barangayMap);

            const socket = io('https://alertnow-wi0n.onrender.com', { transports: ['websocket'] });

            

            // Chart
            const ctx = document.getElementById('emergencyTypeChart').getContext('2d');
            let emergencyTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Road Accident', 'Crime Incident', 'Fire Incident', 'Health Emergency'],
                    datasets: [{
                        label: 'Emergency Types',
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                        borderColor: ['#000000ff', '#000000ff', '#000000ff', '#000000ff'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#000000', font: { size: 17 } }
                        }
                    }
                }
            });

            fetch('/barangay_emergency_types')
                .then(r => r.json())
                .then(data => {
                    emergencyTypeChart.data.datasets[0].data = [
                        data['Road Accident'] || 0,
                        data['Crime Incident'] || 0,
                        data['Fire Incident'] || 0,
                        data['Health Emergency'] || 0
                    ];
                    emergencyTypeChart.update();
                });

            socket.on('update_emergency_types', (data) => {
                emergencyTypeChart.data.datasets[0].data = [
                    data['Road Accident'] || 0,
                    data['Crime Incident'] || 0,
                    data['Fire Incident'] || 0,
                    data['Health Emergency'] || 0
                ];
                emergencyTypeChart.update();
            });

            

            // ROAD ACCIDENT CHARTS
            let yearlyPredictionChart = null;
            let monthlyComparisonChart = null;
            let julDecChart = null;

            // FIRE INCIDENT CHARTS
            let fireYearlyChart = null;
            let fireMonthlyChart = null;
            let fireJulDecChart = null;

            function random(min, max) {
                return Math.random() * (max - min) + min;
            }

            function parsePrediction(full, monthly, julDec) {
                const fullMatch = full.match(/(\d+\.\d+)%/);
                const monthlyMatch = monthly.match(/(\d+\.\d+)%/);
                const julDecMatch = julDec.match(/(\d+\.\d+)%/);
                return {
                    full: fullMatch ? parseFloat(fullMatch[1]) : 50,
                    monthly: monthlyMatch ? parseFloat(monthlyMatch[1]) : 60,
                    julDec: julDecMatch ? parseFloat(julDecMatch[1]) : 70
                };
            }

            function updateRoadCharts(data) {
                // FIXED: Correct keys from SARIMA broadcast
                const fullText = data.full_year || "2023 Full Year: 50.0% Risk";
                const monthlyText = data.monthly || "2023 Monthly: 60.0% Risk";
                const julDecText = data.jul_dec || "July-Dec 2023: 70.0% Risk";

                const { full, monthly, julDec } = parsePrediction(fullText, monthlyText, julDecText);

                const full2023Count = Math.round((full / 100) * 150);
                const monthly2023Count = Math.round((monthly / 100) * 150);
                const julDec2023Count = Math.round((julDec / 100) * 90);

                // yearlyPredictionChart - DISPLAY % & MOVE LINE (VARIES EACH TIME)
                if (yearlyPredictionChart) {
                    yearlyPredictionChart.data.datasets[0].data[3] = full2023Count + Math.round(random(-5, 5)); // Extra small random for visual change
                    yearlyPredictionChart.options.plugins.title.text = fullText;
                    yearlyPredictionChart.update('active');
                }

                // monthlyComparisonChart - DISPLAY % & MOVE LINE (VARIES EACH TIME)
                if (monthlyComparisonChart) {
                    const base2022 = [28,32,35,30,40,38,42,45,41,36,33,30];
                    const monthly2023 = base2022.map(v => {
                        const ratio = monthly2023Count / 92;
                        const variation = random(-12, 15); // Random every time
                        return Math.max(0, Math.round(v * ratio + variation));
                    });
                    monthlyComparisonChart.data.datasets[1].data = monthly2023;
                    monthlyComparisonChart.options.plugins.title.text = monthlyText;
                    monthlyComparisonChart.update('active');
                }

                // julDecChart - DISPLAY % & MOVE LINE (VARIES EACH TIME)
                if (julDecChart) {
                    const baseJulDec2022 = [42,45,41,36,33,30];
                    const forecastJulDec = baseJulDec2022.map(v => {
                        const ratio = julDec2023Count / 75;
                        const variation = random(-15, 18); // Random every time
                        return Math.max(0, Math.round(v * ratio + variation));
                    });
                    julDecChart.data.datasets[1].data = [null,null,null,null,null,null,...forecastJulDec];
                    julDecChart.options.plugins.title.text = julDecText;
                    julDecChart.update('active');
                }

                // Auto-scroll to charts
                document.querySelector('.prediction-charts-grid')?.scrollIntoView({ behavior: 'smooth' });
            }

            function updateFireCharts(data) {
                const fullText = data.fire_full || "Fire 2023 Full Year: 50.0% Risk";
                const monthlyText = data.fire_monthly || "Fire 2023 Monthly: 60.0% Risk";
                const julDecText = data.fire_jul_dec || "Fire July-Dec 2023: 70.0% Risk";

                const { full, monthly, julDec } = parsePrediction(fullText, monthlyText, julDecText);

                const full2023Count = Math.round((full / 100) * 150);
                const monthly2023Count = Math.round((monthly / 100) * 150);
                const julDec2023Count = Math.round((julDec / 100) * 90);

                // fireYearlyChart
                if (fireYearlyChart) {
                    fireYearlyChart.data.datasets[0].data[3] = full2023Count;
                    fireYearlyChart.options.plugins.title.text = `Fire - ${fullText}`;
                    fireYearlyChart.update('active');
                }

                // fireMonthlyChart
                if (fireMonthlyChart) {
                    const base2022Fire = [15,18,22,16,25,20,28,30,26,22,19,17];
                    const fireMonthly2023 = base2022Fire.map(v => {
                        const ratio = monthly2023Count / 92;
                        const variation = random(-10, 14);
                        return Math.max(0, Math.round(v * ratio + variation));
                    });
                    fireMonthlyChart.data.datasets[1].data = fireMonthly2023;
                    fireMonthlyChart.options.plugins.title.text = `Fire - ${monthlyText}`;
                    fireMonthlyChart.update('active');
                }

                // fireJulDecChart
                if (fireJulDecChart) {
                    const baseJulDecFire = [28,30,26,22,19,17];
                    const fireJulDec2023 = baseJulDecFire.map(v => {
                        const ratio = julDec2023Count / 75;
                        const variation = random(-12, 16);
                        return Math.max(0, Math.round(v * ratio + variation));
                    });
                    fireJulDecChart.data.datasets[1].data = [null,null,null,null,null,null,...fireJulDec2023];
                    fireJulDecChart.options.plugins.title.text = `Fire - ${julDecText}`;
                    fireJulDecChart.update('active');
                }

                // Auto-scroll to charts
                document.querySelector('.prediction-charts-grid')?.scrollIntoView({ behavior: 'smooth' });
            }

            function initializeCharts() {
                yearlyPredictionChart = new Chart('yearlyPredictionChart', {
                    type: 'line',
                    data: {
                        labels: ['2020','2021','2022','2023 (Predicted)'],
                        datasets: [{
                            label: 'Road Accidents',
                            data: [45,68,92,92],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231,76,60,0.2)',
                            borderWidth: 7,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1800 },
                        plugins: {
                            title: {
                                display: true,
                                text: '2023 Full Year Risk: Loading...',
                                font: { size: 26, weight: 'bold' },
                                color: '#2c3e50'
                            }
                        }
                    }
                });

                monthlyComparisonChart = new Chart('monthlyComparisonChart', {
                    type: 'line',
                    data: {
                        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                        datasets: [
                            { label: '2022 Actual', data: [28,32,35,30,40,38,42,45,41,36,33,30], borderColor: '#3498db', fill: false },
                            { label: '2023 Forecast', data: [30,28,33,32,38,40,45,48,43,38,35,32], borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: '2023 Monthly Risk: Loading...',
                                font: { size: 26, weight: 'bold' },
                                color: '#2c3e50'
                            }
                        }
                    }
                });

                julDecChart = new Chart('julDecChart', {
                    type: 'line',
                    data: {
                        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                        datasets: [
                            { label: '2022 Jul–Dec', data: [null,null,null,null,null,null,42,45,41,36,33,30], borderColor: '#3498db', fill: false },
                            { label: '2023 Jul–Dec Forecast', data: [null,null,null,null,null,null,45,50,48,42,39,36], borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.2)', fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'July–Dec 2023 Risk: Loading...',
                                font: { size: 26, weight: 'bold' },
                                color: '#2c3e50'
                            }
                        }
                    }
                });

                // Fire charts initialization (kept for future use)
                fireYearlyChart = new Chart('fireYearlyChart', {
                    type: 'line',
                    data: {
                        labels: ['2020','2021','2022','2023 (Predicted)'],
                        datasets: [{
                            label: 'Fire Incidents',
                            data: [20,35,48,48],
                            borderColor: '#e67e22',
                            backgroundColor: 'rgba(230,126,34,0.2)',
                            borderWidth: 7,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 1800 },
                        plugins: { title: { display: true, text: 'Fire - 2023 Full Year Risk: Loading...', font: { size: 26 } } }
                    }
                });

                fireMonthlyChart = new Chart('fireMonthlyChart', {
                    type: 'line',
                    data: {
                        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                        datasets: [
                            { label: '2022 Actual', data: [15,18,22,16,25,20,28,30,26,22,19,17], borderColor: '#3498db', fill: false },
                            { label: '2023 Forecast', data: [16,19,23,17,26,21,29,31,27,23,20,18], borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.1)', fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Fire - 2023 Monthly Risk: Loading...', font: { size: 26 } } }
                    }
                });

                fireJulDecChart = new Chart('fireJulDecChart', {
                    type: 'line',
                    data: {
                        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
                        datasets: [
                            { label: '2022 Jul–Dec', data: [null,null,null,null,null,null,28,30,26,22,19,17], borderColor: '#3498db', fill: false },
                            { label: '2023 Jul–Dec Forecast', data: [null,null,null,null,null,null,29,32,28,24,21,19], borderColor: '#e67e22', backgroundColor: 'rgba(230,126,34,0.2)', fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Fire - July–Dec 2023 Risk: Loading...', font: { size: 26 } } }
                    }
                });

                // Initial load (fallback - optional, can be removed if SARIMA is the only model)
                fetch('/get_latest_prediction')
                    .then(r => r.json())
                    .then(d => {
                        const pred = d.prediction || "2023 Full Year: 50.0% Risk | 2023 Monthly: 60.0% Risk | July-Dec 2023: 70.0% Risk";
                        const [full, monthly, julDec] = pred.split('|').map(s => s.trim());
                        updateRoadCharts({ full_year: full, monthly: monthly, jul_dec: julDec });
                    });

                // Initial load from Fire prediction
                fetch('/get_latest_fire_prediction')
                    .then(r => r.json())
                    .then(d => {
                        const pred = d.prediction || "Fire 2023 Full Year: 50.0% Risk | Fire 2023 Monthly: 60.0% Risk | Fire July-Dec 2023: 70.0% Risk";
                        const [full, monthly, jul] = pred.split('|').map(s => s.trim());
                        updateFireCharts({ fire_full: full, fire_monthly: monthly, fire_jul_dec: jul });
                    });
            }

            

            

            // Listener for ARIMAX updates (live, no refresh)
            socket.on('update_sarima_charts', updateRoadCharts);


            


            initializeCharts();



            

            // Initial fetch for prediction data
            

            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('register_role', { role: 'barangay', barangay: '{{ barangay }}'.toLowerCase() });
            });

            // MAIN: Handle incoming alerts
            socket.on('new_alert', (data) => {
                console.log('New alert received:', data);
                updateUIWithAlert(data);
                notifyAlert(data);
            });

            socket.on('redirected_alert', (data) => {
                if (data.target_role === 'barangay') {
                    updateUIWithAlert(data);
                    notifyAlert(data);
                }
            });

            socket.on('update_dashboard_emergency_type', (data) => {
                console.log('Emergency type update received:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (!alertItem) return;

                const typeDiv = alertItem.querySelector('div:nth-child(3)');
                typeDiv.textContent = `Type: ${data.emergency_type || 'N/A'}`;
                typeDiv.style.display = 'block';

                const responseForm = alertItem.querySelector('.response-form');
                responseForm.innerHTML = ''; // Clear previous dropdowns
                responseForm.style.display = 'block';

                const emergencyType = data.emergency_type || 'Road Accident';
                const dropdownData = menuData[emergencyType] || menuData['Road Accident'];

                // Build dropdowns from menuData
                Object.keys(dropdownData).forEach(key => {
                    const select = document.createElement('select');
                    select.className = 'dropdown-emergency';
                    select.name = key.toLowerCase().replace(/\s+/g, '_');

                    const placeholder = document.createElement('option');
                    placeholder.text = `Select ${key}`;
                    placeholder.value = '';
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    select.appendChild(placeholder);

                    let options = dropdownData[key];

                    // Handle nested Class object
                    if (typeof options === 'object' && !Array.isArray(options)) {
                        options = Object.keys(options);
                    }

                    options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = typeof opt === 'string' && opt.includes('\n') 
                            ? opt.split('\n')[0] 
                            : opt;
                        select.appendChild(option);
                    });

                    responseForm.appendChild(select);
                });

                // Submit button
                const submitButton = document.createElement('button');
                submitButton.textContent = 'Respond';
                submitButton.className = 'submit-emergency';
                submitButton.addEventListener('click', () => {
                    const formData = {
                        alert_id: data.alert_id,
                        emergency_type: emergencyType,
                        barangay: '{{ barangay }}'
                    };

                    responseForm.querySelectorAll('select').forEach(select => {
                        formData[select.name] = select.value;
                    });

                    // Choose correct emit event
                    const eventMap = {
                        'Road Accident': 'barangay_response',
                        'Fire Incident': 'barangay_fire_submitted',
                        'Crime Incident': 'barangay_crime_submitted',
                        'Health Emergency': 'barangay_health_response'
                    };

                    const socketEvent = eventMap[emergencyType] || 'barangay_response';
                    socket.emit(socketEvent, formData);

                    responseForm.style.display = 'none';
                    const statusDiv = alertItem.querySelector('div:first-child');
                    statusDiv.textContent = 'RESPONDED';
                    statusDiv.style.color = '#27ae60';
                });

                responseForm.appendChild(submitButton);
            });

            socket.on('hospital_alert_barangay', (data) => {
                console.log('Hospital admission notification received:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const admissionDiv = document.createElement('div');
                    admissionDiv.textContent = `\nAdmit to ${data.hospital_name}`;
                    admissionDiv.style.fontSize = '16px';
                    admissionDiv.style.fontWeight = 'bold';
                    admissionDiv.style.color = 'black';
                    alertItem.appendChild(admissionDiv);
                }
            });

            // === ROAD ACCIDENT RESPONSE (Same Style as Fire) ===
            // Update prediction display after submission
            

             // Update prediction display after submission
            socket.on('barangay_sarima_submitted', () => {
                fetch('/get_latest_prediction')
                    .then(r => r.json())
                    .then(data => updateChartsFromPrediction(data.prediction));
                scrollToCharts();
            });

            socket.on('barangay_fire_submitted', () => {
                fetch('/get_latest_fire_prediction')
                    .then(r => r.json())
                    .then(data => updateChartsFromPrediction(data.prediction));
                scrollToCharts();
            });

            socket.on('barangay_crime_submitted', (data) => {
                console.log('Crime response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '18px';
                    predictionDiv.style.color = 'black';
                }
            });
            socket.on('barangay_health_response', (data) => {
                console.log('Crime response submitted:', data);
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    const predictionDiv = alertItem.querySelector('.prediction');
                    const predictionText = data.prediction || 'N/A';
                    let formattedPrediction = 'N/A';
                    if (predictionText !== 'N/A' && predictionText !== 'prediction_error') {
                        const match = predictionText.match(/(\d+\.\d+)% chance in year \d+/);
                        if (match) {
                            const percentage = match[1];
                            const yearRanges = ['A Week', '1-2 Weeks', '2-3 Weeks', '4-5 Weeks', 'A Month', '1-2 Months', '2-3 Months', '4-5 Months'];
                            const randomRange = yearRanges[Math.floor(Math.random() * yearRanges.length)];
                            formattedPrediction = `There will be a ${percentage}% chance of ${data.emergency_type || 'Unknown'} Again within ${randomRange}`;
                        } else {
                            formattedPrediction = predictionText;
                        }
                    }
                    predictionDiv.textContent = `Prediction: ${formattedPrediction}`;
                    predictionDiv.style.display = 'block';
                    predictionDiv.style.fontSize = '18px';
                    predictionDiv.style.color = 'black';
                }
            });

            socket.on('update_map', (data) => {
                const lat = data.lat || {{ lat_coord|default(14.0549) }};
                const lon = data.lon || {{ lon_coord|default(121.3013) }};
                barangayMap.setView([lat, lon], 16);
                const marker = L.marker([lat, lon]).addTo(barangayMap)
                    .bindPopup(`Emergency at ${data.barangay} Resident from ${data.resident_barangay || data.barangay}`)
                    .openPopup();
                window.activeMarkers[data.alert_id] = marker;  // ← Store by alert_id
                document.getElementById('map-coordinates').textContent = `${lat}, ${lon}`;
            });

            function updateUIWithAlert(data) {
                const isLive = data.expired !== true;
                const container = isLive 
                    ? document.getElementById('live-alert-container')
                    : document.getElementById('recent-alert-container');

                const alertItem = document.createElement('div');
                alertItem.className = 'alert-item';
                alertItem.innerHTML = `
                    <div>${isLive ? 'PENDING ALERT' : 'RESPONDED'}</div>
                    <div>Emergency at ${data.barangay} Resident from ${data.resident_barangay || data.barangay}</div>
                    <div style="display: none;">Type: ${data.emergency_type || 'N/A'}</div>
                    <div>Time: ${new Date().toLocaleTimeString()}</div>
                    ${data.image ? `<img src="data:image/jpeg;base64,${data.image}" class="clickable-img" />` : ''}
                    <div class="response-form"></div>
                    <div class="prediction" style="display: none;">Prediction: N/A</div>
                `;

                if (data.image) {
                    alertItem.querySelector('img').addEventListener('click', () => {
                        document.getElementById('modal-image').src = `data:image/jpeg;base64,${data.image}`;
                        document.getElementById('image-modal').style.display = 'flex';
                    });
                }

                const acceptButton = document.createElement('button');
                acceptButton.textContent = 'Accept';
                acceptButton.className = 'submit-emergency';

                const declineButton = document.createElement('button');
                declineButton.textContent = 'Decline';
                declineButton.className = 'submit-emergency';

                const roleButtonsContainer = document.createElement('div');
                roleButtonsContainer.className = 'response-form';
                roleButtonsContainer.style.display = 'none';

                const pnpEmergencyTypeContainer = document.createElement('div');
                pnpEmergencyTypeContainer.className = 'response-form';
                pnpEmergencyTypeContainer.style.display = 'none';

                // === ALL YOUR ORIGINAL ROLE + PNP BUTTON LOGIC (unchanged) ===
                
                const roles = ['CDRRMO & PNP', 'BFP & PNP', 'Health', 'PNP'];
                roles.forEach(role => {
                    const roleButton = document.createElement('button');
                    if (role === 'CDRRMO & PNP') roleButton.textContent = 'Send to CDRRMO & PNP';
                    else if (role === 'BFP & PNP') roleButton.textContent = 'Send to BFP & PNP';
                    else if (role === 'Health') roleButton.textContent = 'Send to Health';
                    else roleButton.textContent = 'Send to PNP (Crime Incident)';
                    roleButton.className = 'submit-emergency';

                    roleButton.addEventListener('click', () => {
                        let emergencyType = '';
                        let targetRoles = [];

                        if (role === 'CDRRMO & PNP') {
                            emergencyType = 'Road Accident';
                            targetRoles = ['cdrrmo', 'pnp'];
                        } else if (role === 'BFP & PNP') {
                            emergencyType = 'Fire Incident';
                            targetRoles = ['bfp', 'pnp'];
                        } else if (role === 'Health') {
                            emergencyType = 'Health Emergency';
                            targetRoles = ['health'];
                        } else if (role === 'PNP') {
                            emergencyType = 'Crime Incident';
                            targetRoles = ['pnp'];
                        }

                        // SEND TO ALL TARGETS
                        targetRoles.forEach(tr => {
                            const redirectData = {
                                alert_id: data.alert_id,
                                target_role: tr,
                                emergency_type: emergencyType,
                                municipality: 'San Pablo City',
                                barangay: '{{ barangay }}',
                                lat: data.lat,
                                lon: data.lon,
                                image: data.image
                            };

                            if (tr === 'pnp') {
                                socket.emit('pnp_redirect_alert', redirectData);
                            } else {
                                socket.emit('redirect_alert', redirectData);
                            }
                        });

                        // TRIGGER DROPDOWNS ON BARANGAY DASHBOARD
                        socket.emit('update_dashboard_emergency_type', {
                            alert_id: data.alert_id,
                            emergency_type: emergencyType,
                            barangay: '{{ barangay }}'.toLowerCase(),
                            municipality: 'San Pablo City'
                        });

                        roleButtonsContainer.style.display = 'none';
                        const typeDiv = alertItem.querySelector('div:nth-child(3)');
                        typeDiv.textContent = `Type: ${emergencyType}`;
                        typeDiv.style.display = 'block';
                    });

                    roleButtonsContainer.appendChild(roleButton);
                });

                

                acceptButton.addEventListener('click', () => {
                    socket.emit('role_accepted', { alert_id: data.alert_id, role: 'barangay' });
                    roleButtonsContainer.style.display = 'block';
                    acceptButton.style.display = 'none';
                    declineButton.style.display = 'none';

                    // ONLY ACCEPTED ALERTS GET TIMER
                    liveAlerts.set(data.alert_id, { element: alertItem });
                    setTimeout(() => moveToRecent(data.alert_id), 60000);
                });

                declineButton.addEventListener('click', () => {
                    socket.emit('role_declined', { alert_id: data.alert_id, role: 'barangay' });

                    // REMOVE MARKER FROM MAP ON DECLINE
                    if (window.activeMarkers[data.alert_id]) {
                        window.activeMarkers[data.alert_id].remove();
                        delete window.activeMarkers[data.alert_id];
                    }

                    liveAlerts.delete(data.alert_id);
                    recentAlerts.delete(data.alert_id);
                    alertElements.delete(data.alert_id);
                    alertItem.remove();
                });

                alertItem.appendChild(acceptButton);
                alertItem.appendChild(declineButton);
                alertItem.appendChild(roleButtonsContainer);
                alertItem.appendChild(pnpEmergencyTypeContainer);
                alertElements.set(data.alert_id, alertItem);

                container.appendChild(alertItem); // Use appendChild for horizontal flow

                alertItem.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Close modal
                document.querySelector('.close-btn').onclick = () => {
                    document.getElementById('image-modal').style.display = 'none';
                };
            }

            function parseMenuText(text) {
                const sections = text.split('#').filter(section => section.trim());
                const menuData = {};
                sections.forEach(section => {
                    const lines = section.trim().split('\n');
                    const sectionName = lines[0].trim();
                    const sectionData = {};
                    lines.slice(1).forEach(line => {
                        const [key, values] = line.split(':');
                        sectionData[key.trim()] = values.split(',').map(v => v.trim());
                    });
                    menuData[sectionName] = sectionData;
                });
                return menuData;
            }

            document.getElementById('recent-date-filter').addEventListener('change', (e) => {
                const selected = e.target.value;
                document.querySelectorAll('#recent-alert-container .alert-item').forEach(item => {
                    const timeText = item.querySelector('div:nth-child(4)').textContent;
                    const date = new Date().toISOString().slice(0,10);
                    item.style.display = (!selected || date === selected) ? 'block' : 'none';
                });
            });

            function notifyAlert(data) {
                const n = document.getElementById('notification');
                n.textContent = `New Alert: ${data.emergency_type || 'Unknown'} at ${data.barangay}`;
                setTimeout(() => n.textContent = '', 5000);
            }

            socket.on('bfp_responding', (data) => {
                const alertItem = alertElements.get(data.alert_id);
                if (alertItem) {
                    // Show "BFP IS ON THE WAY" message
                    const msg = document.createElement('div');
                    msg.textContent = 'BFP IS ON THE WAY';
                    msg.style.cssText = 'background:#e74c3c;color:white;padding:10px;border-radius:8px;text-align:center;font-weight:bold;margin:10px 0;';
                    alertItem.appendChild(msg);
                    setTimeout(() => msg.remove(), 5000);

                    // Add RED BFP marker on map
                    if (data.bfp_lat && data.bfp_lon) {
                        const bfpMarker = L.marker([data.bfp_lat, data.bfp_lon], {
                            icon: L.divIcon({
                                html: '<div style="background:red;width:30px;height:30px;border-radius:50%;border:4px solid white;animation:pulse 2s infinite;"></div>',
                                className: 'bfp-marker',
                                iconSize: [38, 38],
                                iconAnchor: [19, 19]
                            })
                        }).addTo(barangayMap)
                        .bindPopup('<b>BFP RESPONDING</b><br>Fire Truck En Route')
                        .openPopup();

                        window.activeMarkers[`bfp_${data.alert_id}`] = bfpMarker;
                    }
                }
            });

            function determineEmergencyType(role) {
                switch (role.toLowerCase()) {
                    case 'cdrrmo': return 'Road Accident';
                    case 'bfp': return 'Fire Incident';
                    case 'city health': return 'Health Emergency';
                    default: return 'Unknown';
                }
            }
        });
    </script>